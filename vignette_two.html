<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />



<title>cron jobs w/ betfaiR</title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.1/css/united.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.1/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/respond.min.js"></script>
<style type="text/css">

	/* padding for bootstrap navbar */
	body {
		padding-top: 20px;
		padding-bottom: 20px;
	}
	@media (max-width: 979px) {
		body {
			padding-top: 0;
		}
	}

	/* offset scroll position for anchor links (for fixed navbar) */
	@media (min-width: 980px) {
		.section h2 {
			padding-top: 52px;
			margin-top: -52px;
		}
		.section h3 {
			padding-top: 52px;
			margin-top: -52px;
		}
	}

	p {
		font-size: 13px;
	}

	/* don't use link color in navbar */
	.dropdown-menu>li>a {
		color: black;
	}

	/* some padding for disqus */
	#disqus_thread {
		margin-top: 45px;
	}

</style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<link rel="stylesheet" href="styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>
<div class="container-fluid main-container">

<h1>betfaiR</h1>
<nav class="navbar navbar-inverse">
    <div class="container-fluid">
        <div class="navbar-header">
            <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#betfaiR-nav">
                <span class="sr-only">Toggle Navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://github.com/durtal" class="navbar-brand">durtal@github</a>
        </div>
        <div class="collapse navbar-collapse" id="betfaiR-nav">
            <ul class="nav navbar-nav">
                <li>
                    <a href="index.html">home</a>
                </li>
                <li class="dropdown">
                    <a href="Primary" class="dropdown-toggle" data-toggle="dropdown">
                        functions <b class="caret"></b>
                    </a>
                    <ul class="dropdown-menu">
                        <li class="dropdown-header">environment</li>
                        <li>
                            <a href="betfair.html">betfair</a>
                        </li>
                        <li class="dropdown-header">functions</li>
                        <li>
                            <a href="betfair_login.html">bf_login</a>
                        </li>
                        <li>
                            <a href="bf_account.html">bf_account</a>
                        </li>
                        <li>
                            <a href="request_functions.html">bf_request</a>
                        </li>
                        <li>
                            <a href="betfair_POST.html">bf_post</a>
                        </li>
                        <li>
                            <a href="betfair_check.html">bf_check</a>
                        </li>
                        <li>
                            <a href="betfair_parse.html">bf_parse</a>
                        </li>
                        <li class="dropdown-header">helpers</li>
                        <li>
                            <a href="marketFilter.html">marketFilter</a>
                        </li>
                        <li>
                            <a href="bf_helpers.html">bet instructions</a>
                        </li>
                    </ul>
                </li>
                <li class="dropdown">
                    <a href="Methods" class="dropdown-toggle" data-toggle="dropdown">
                        methods <b class="caret"></b>
                    </a>
                    <ul class="dropdown-menu">
                        <li class="dropdown-header">summary data</li>
                        <li>
                            <a href="methods_competitions.html">competitions</a>
                        </li>
                        <li>
                            <a href="methods_countries.html">countries</a>
                        </li>
                        <li>
                            <a href="methods_events.html">events</a>
                        </li>
                        <li>
                            <a href="methods_eventTypes.html">eventTypes</a>
                        </li>
                        <li>
                            <a href="methods_venues.html">venues</a>
                        </li>
                        <li class="dropdown-header">login</li>
                        <li>
                            <a href="login_session.html">login + session</a>
                        </li>
                        <li class="dropdown-header">market data</li>
                        <li>
                            <a href="methods_marketTypes.html">marketTypes</a>
                        </li>
                        <li>
                            <a href="methods_marketCatalogue.html">marketCatalogue</a>
                        </li>
                        <li>
                            <a href="methods_marketBook.html">marketBook</a>
                        </li>
                        <li>
                            <a href="methods_marketPnL.html">marketPnL</a>
                        </li>
                        <li class="dropdown-header">orders</li>
                        <li>
                            <a href="cancelOrders.html">cancelOrders</a>
                        </li>
                        <li>
                            <a href="clearedOrders.html">clearedOrders</a>
                        </li>
                        <li>
                            <a href="currentOrders.html">currentOrders</a>
                        </li>
                        <li>
                            <a href="placeOrders.html">placeOrders</a>
                        </li>
                        <li>
                            <a href="replaceOrders.html">replaceOrders</a>
                        </li>
                        <li>
                            <a href="updateOrders.html">updateOrders</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a href="Misc" class="dropdown-toggle" data-toggle="dropdown">
                        misc <b class="caret"></b>
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="betting_enums.html">Betting Enums</a>
                        </li>
                    </ul>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li class="dropdown">
                    <a href="vignettes" class="dropdown-toggle" data-toggle="dropdown">
                        vignettes <b class="caret"></b>
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="vignette_one.html">place a bet</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div id="header">
<h1 class="title">cron jobs w/ betfaiR</h1>
</div>


<p>This vignette will walk through the use of <code>betfaiR</code> to collect data over time - the markets we will focus on is the match odds markets for Man City vs Spurs and Arsenal vs Leicester, as well as the Premier League outright market. However this approach can be used for collecting data about other markets, to potentially build models and establish trading strategies.</p>
<p>I will try to explain how to perform similar tasks on both Windows and Linux/OSX machines, this will involve creating an R script and using a Task scheduler (Task Scheduler on Windows and <a href="https://en.wikipedia.org/wiki/Cron">cron</a> on Linux/OSX); this <a href="https://trinkerrstuff.wordpress.com/2015/02/11/scheduling-r-tasks-via-windows-task-scheduler/">blog</a> by <a href="https://twitter.com/tylerrinker">Tyler Rinker</a> has been very useful to me.</p>
<p>As an example, the plot below shows the minute by minute Betfair price data during the course of a football match between Manchester United and Manchester City:</p>
<p><img src="manchester-derby.jpeg" style="display: block; margin-left: auto; margin-right: auto"></p>
<p>There are a few things that we will need to do:</p>
<ul>
<li>to create an R script that will use changing variables
<ul>
<li>variables will be the marketIds which will change day to day</li>
</ul></li>
<li>to store data in .RDS or RData files, data will include
<ul>
<li>marketId</li>
<li>returned market data</li>
</ul></li>
</ul>
<div id="find-markets" class="section level2">
<h2>Find markets</h2>
<p>First, some familiarity with events, competitions, and markets will help with creating an R script to automate the collection of data. As we are focussing on the Premier League, we need an eventTypeId, a competitionId, which will help us to find the markets we are interested in.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># load betfaiR and login</span>
<span class="kw">library</span>(betfaiR)
bf &lt;-<span class="st"> </span><span class="kw">betfair</span>(<span class="dt">usr =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;BETFAIR_USR&quot;</span>),
              <span class="dt">pwd =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;BETFAIR_PWD&quot;</span>),
              <span class="dt">key =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;BETFAIR_KEY&quot;</span>))</code></pre>
<pre><code>Login successful</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># find correct eventTypeIds</span>
eventTypeIds &lt;-<span class="st"> </span>bf$<span class="kw">eventTypes</span>()
eventTypeIds[<span class="kw">grepl</span>(<span class="st">&quot;soccer|football&quot;</span>, eventTypeIds$eventType_name, <span class="dt">ignore.case =</span> <span class="ot">TRUE</span>),]</code></pre>
<pre><code>   eventType_id    eventType_name marketCount
2             1            Soccer       23879
26         6423 American Football           1</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># soccer/football has eventTypeId of 1, lets use that along with marketCountries to find the Premier League competition</span>
competitions &lt;-<span class="st"> </span>bf$<span class="kw">competitions</span>(<span class="dt">filter =</span> <span class="kw">marketFilter</span>(<span class="dt">eventTypeIds =</span> <span class="dv">1</span>,
                                                      <span class="dt">marketCountries =</span> <span class="st">&quot;GB&quot;</span>))
competitions[<span class="kw">grepl</span>(<span class="st">&quot;premier&quot;</span>, competitions$competition_name, <span class="dt">ignore.case =</span>  <span class="ot">TRUE</span>),]</code></pre>
<pre><code>   competition_id        competition_name marketCount competitionRegion
6           20351        NIFL Premiership          54               GBR
9              31 Barclays Premier League         880               GBR
14         252549    Welsh Premier League          72               GBR
21            105    Scottish Premiership         201               GBR
23         820588        Southern Premier          40               GBR
24         820753        Northern Premier          30               GBR
27         820582        Isthmian Premier          32               GBR</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># the Premier League has a competition id of 31, we can find the different market types for this competition</span>
marketTypes &lt;-<span class="st"> </span>bf$<span class="kw">marketTypes</span>(<span class="dt">filter =</span> <span class="kw">marketFilter</span>(<span class="dt">competitionIds =</span> <span class="dv">31</span>))</code></pre>
<pre><code>             marketType marketCount
1                WINNER           1
33  MATCH_ODDS_AND_BTTS          10
51 MATCH_ODDS_AND_OU_25          10
54           MATCH_ODDS          16</code></pre>
<p>The marketIds of the two matches (Man City vs Spurs and Arsenal vs Leicester) and the outright winner of the Premier League are shown below:</p>
<p>The following are the three markets of interest, which were collected and saved sometime on Weds 10th Feb 2016.</p>
<pre><code>
Market ID:      1.122843814
Event ID:       27674404 
Market Name:    Match Odds
Event Name:     Man City v Tottenham 
Matched:        62869.59
 ---------------------------------------------------------------------------
Market ID:      1.122843669
Event ID:       27674402 
Market Name:    Match Odds
Event Name:     Arsenal v Leicester 
Matched:        82476.81
 ---------------------------------------------------------------------------
Market ID:      1.118280148
Event ID:       2022802 
Market Name:    2015/16 Winner
Event Name:     Barclays Premier League 
Matched:        13345021.84
 ---------------------------------------------------------------------------</code></pre>
</div>
<div id="r-script" class="section level2">
<h2>R script</h2>
<p>A script will need to login, find the correct markets, retreive the relevant data, and then save the data. The process of finding the correct markets neednâ€™t be repeated time after time, so this data can be retrieved once, saved and then loaded every time. Although the script needs to be able to run straight off the bat, so it might look something like the code below:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(betfaiR)

bf &lt;-<span class="st"> </span><span class="kw">betfair</span>(<span class="dt">usr =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;BETFAIR_USR&quot;</span>),
              <span class="dt">pwd =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;BETFAIR_PWD&quot;</span>),
              <span class="dt">key =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;BETFAIR_KEY&quot;</span>))

files &lt;-<span class="st"> </span><span class="kw">list.files</span>()

if(!(<span class="st">&quot;marketIds.RDS&quot;</span> %in%<span class="st"> </span>files)) {
    cittot &lt;-<span class="st"> </span>bf$<span class="kw">marketCatalogue</span>(<span class="dt">filter =</span> <span class="kw">marketFilter</span>(<span class="dt">competitionIds =</span> <span class="dv">31</span>,
                                                       <span class="dt">textQuery =</span> <span class="st">&quot;Tottenham&quot;</span>,
                                                       <span class="dt">to =</span> <span class="st">&quot;2016-02-15&quot;</span>,
                                                       <span class="dt">marketTypeCodes =</span> <span class="st">&quot;MATCH_ODDS&quot;</span>),
                                 <span class="dt">maxResults =</span> <span class="dv">10</span>)
    arslei &lt;-<span class="st"> </span>bf$<span class="kw">marketCatalogue</span>(<span class="dt">filter =</span> <span class="kw">marketFilter</span>(<span class="dt">competitionIds =</span> <span class="dv">31</span>,
                                                       <span class="dt">textQuery =</span> <span class="st">&quot;Arsenal&quot;</span>,
                                                       <span class="dt">to =</span> <span class="st">&quot;2016-02-15&quot;</span>,
                                                       <span class="dt">marketTypeCodes =</span> <span class="st">&quot;MATCH_ODDS&quot;</span>),
                                 <span class="dt">maxResults =</span> <span class="dv">10</span>)
    winner &lt;-<span class="st"> </span>bf$<span class="kw">marketCatalogue</span>(<span class="dt">filter =</span> <span class="kw">marketFilter</span>(<span class="dt">competitionIds =</span> <span class="dv">31</span>,
                                                       <span class="dt">marketTypeCodes =</span> <span class="st">&quot;WINNER&quot;</span>))
    marketIds &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">cittot =</span> cittot, <span class="dt">arslei =</span> arslei, <span class="dt">winner =</span> winner)
    <span class="kw">saveRDS</span>(marketIds, <span class="st">&quot;marketIds.RDS&quot;</span>)
} else {
    marketIds &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;marketIds.RDS&quot;</span>)
}</code></pre>
<a href="https://github.com/durtal/betfaiR" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#d9230f; color:#fcfcfc; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>
<style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
</div>


</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>


</body>
</html>
